TOPDIR ?= $(CURDIR)/..
export TOPDIR
include $(TOPDIR)/global_config

CFLAGS += -I../ -I$(CINELERRA) -I$(GUICAST) -I../colors -fPIC

CFLAGS += $(static_incs)
LFLAGS += $(static_libs)
LDLINKER ?= g++ -shared
$(shell mkdir -p $(OBJDIR))

PLUGIN_DIR := $(BINDIR)/plugins
OUTPUT_DIR = $(PLUGIN_DIR)/$($(PLUGIN))
PLUGIN_PNGS = $(wildcard $(foreach t,$(themes),$(t).png)) picon.png
OUTPUT_PNGS = $(foreach png,$(PLUGIN_PNGS), $(PLUGIN_DIR)/$(basename $(png))/$(PLUGIN).png)
OUTPUT = $(OUTPUT_DIR)/$(PLUGIN).plugin
OUTPUT_G = $(OBJDIR)/$(PLUGIN).debuginfo

$(shell echo $(CFLAGS) > $(OBJDIR)/c_flags)
$(shell echo $(LFLAGS) > $(OBJDIR)/l_flags)

ifeq ($(OUTPUT_THEME),)

$(OUTPUT): $(OBJS) $(OUTPUT_DIR) $(OUTPUT_PNGS)
	$(LDLINKER) -o $(OUTPUT) $(OBJS) `cat $(OBJDIR)/l_flags`
	$(if $(findstring -g,$(CFLAGS)),objcopy --only-keep-debug $(OUTPUT) $(OUTPUT_G))
	$(if $(findstring -ggdb,$(CFLAGS)),,strip $(OUTPUT))

else

THEME_DATA = $(OBJDIR)/$(PLUGIN)_data.o

$(OUTPUT_THEME): $(OBJS) $(OUTPUT_DIR) $(THEME_DATA)
	$(LDLINKER) -o $(OUTPUT_THEME) $(OBJS) $(THEME_DATA)
	$(if $(findstring -g,$(CFLAGS)),objcopy --only-keep-debug $(OUTPUT_THEME) $(OUTPUT_G))
	$(if $(findstring -ggdb,$(CFLAGS)),,strip $(OUTPUT_THEME))

$(THEME_DATA):
	cd $(OBJDIR) && \
	../../../guicast/$(OBJDIR)/bootstrap $(notdir $(THEME_DATA)) ../data/*.png

endif

$(OUTPUT_DIR):
	mkdir -p $@

$(PLUGIN_DIR)/%/$(PLUGIN).png:	%.png
	$(if $(wildcard $(dir $@)),,mkdir -p $(dir $@))
	cp -a $< $@

clean:
	find \( -name core -o -name '*.o' -o -name '*.a' \) -exec rm -f {} \;
	rm -f $(OUTPUT)
	rm -rf $(OBJDIR)

wc:
	cat *.C *.h | wc

$(OBJS):
	$(CC) -c `cat $(OBJDIR)/c_flags` $(subst $(OBJDIR)/,, $*.C) -o $*.o

val-%:
	@echo $($(subst val-,,$@))

